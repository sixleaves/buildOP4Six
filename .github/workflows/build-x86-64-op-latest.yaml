name: build-x86-64-op-latest
on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'

env:
  IB_REPO: sixleaves/buildOP4Six
  IB_TAG: IB-latest
  FIRMWARE_NAME: immortalwrt
  TZ: Asia/Shanghai
  DIY_FILES: files/x86-64/files

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. 拉取代码仓库
        uses: actions/checkout@v4

      - name: 2. 获取上游版本信息
        id: get_version
        run: |
          TAGS=$(curl -s https://api.github.com/repos/immortalwrt/immortalwrt/tags | jq -r '.[].name')
          LATEST_STABLE=$(echo "$TAGS" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -rV | head -n1)
          if [ -z "$LATEST_STABLE" ]; then
            echo "MAIN_VERSION=24.10-SNAPSHOT" >> $GITHUB_ENV
            echo "REPO_BRANCH=openwrt-24.10" >> $GITHUB_ENV
          else
            MAIN_VERSION=$(echo $LATEST_STABLE | sed 's/^v//')
            echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_ENV    
            echo "REPO_BRANCH=openwrt-$MAIN_VERSION" >> $GITHUB_ENV
          fi
          echo "Build Version: $MAIN_VERSION"

      - name: 3. 安装编译依赖
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses-dev zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 zstd parted

      - name: 4. 下载并解压 ImageBuilder
        run: |
          echo "正在从 $IB_REPO 下载 ImageBuilder..."
          ASSET_URL=$(curl -s "https://api.github.com/repos/${{ env.IB_REPO }}/releases/tags/${{ env.IB_TAG }}" | jq -r '.assets[] | select(.name | contains("immortalwrt-imagebuilder-x86-64")) | .browser_download_url' | head -n 1)
          
          if [ -z "$ASSET_URL" ]; then
            echo "Error: Could not find ImageBuilder asset!"
            exit 1
          fi
          
          wget -q "$ASSET_URL" -O ib.tar.zst
          tar -I zstd -xf ib.tar.zst
          rm ib.tar.zst
          mv immortalwrt-imagebuilder-* ib_dir
          
          if [ ! -d "ib_dir" ]; then
             echo "Error: Extraction failed."
             exit 1
          fi

      - name: 5. 注入自动扩容脚本与自定义配置
        run: |
          # --- 核心：生成自动扩容脚本 (Fdisk 版) ---
          # 既然源里没有 parted，我们用 fdisk 实现同样的功能
          mkdir -p ib_dir/files/etc/uci-defaults
          
          cat << 'EOF' > ib_dir/files/etc/uci-defaults/99-resize-rootfs
          #!/bin/sh
          
          # 1. 找到主硬盘
          disk=$(ls /dev/sd[a-z] 2>/dev/null | head -n 1)
          [ -z "$disk" ] && disk="/dev/mmcblk0"
          [ -z "$disk" ] && exit 0
          
          # 2. 这里的逻辑是：扩容最后一个分区
          # 使用 fdisk 获取分区信息，或者直接尝试扩容最后一个
          # 下面的命令序列含义：
          # d: 删除分区
          # (默认回车): 选择最后一个分区
          # n: 新建分区
          # (默认回车): 选择分区号
          # (默认回车): 起始扇区默认（原位置）
          # (默认回车): 结束扇区默认（最大）
          # w: 写入
          # N: 如果询问是否移除签名，回答 No (保留数据头)
          
          echo -e "d\n\nn\n\n\n\nN\nw" | fdisk "$disk" > /dev/null 2>&1
          
          # 3. 重新读取分区表
          partprobe "$disk" 2>/dev/null
          
          # 4. 获取最后一个分区名用于 resize
          # 兼容 /dev/sda2 和 /dev/mmcblk0p2 两种格式
          if echo "$disk" | grep -q "mmcblk"; then
            part_num=$(fdisk -l "$disk" | tail -n 1 | awk '{print $1}' | sed 's/.*p//')
            target="${disk}p${part_num}"
          else
            part_num=$(fdisk -l "$disk" | tail -n 1 | awk '{print $1}' | sed 's/.*[a-z]//')
            target="${disk}${part_num}"
          fi
          
          # 5. 扩容文件系统 (需要 e2fsprogs 包)
          resize2fs "$target" 2>/dev/null
          
          # 6. 删除自身并重启
          rm -f /etc/uci-defaults/99-resize-rootfs
          reboot
          EOF
          
          chmod +x ib_dir/files/etc/uci-defaults/99-resize-rootfs
          echo "自动扩容脚本 (Fdisk版) 已注入。"
          
          # --- 注入用户自定义文件 ---
          if [ -d "${{ env.DIY_FILES }}" ]; then
            echo "Copying custom files from ${{ env.DIY_FILES }}..."
            cp -r ${{ env.DIY_FILES }}/* ib_dir/files/
          else
            echo "No custom files found in ${{ env.DIY_FILES }}, skipping."
          fi

      - name: 6. 开始构建固件
        run: |
          cd ib_dir
          echo -e "$(nproc) thread compile"
          
          # ---------------------------------------------------------------------
          # 关键修改点：
          # 1. 移除了 parted, losetup, resize2fs (这些名字在源里找不到)
          # 2. 添加了 e2fsprogs (它包含 resize2fs 命令，这是必须的)
          # 3. fdisk 通常包含在 base-files 或 busybox 中，为了保险也可以不写，或者写 fdisk
          # ---------------------------------------------------------------------
          
          make image PROFILE="generic" FILES="files" ROOTFS_PARTSIZE=5120 PACKAGES="custom-scripts \
          -dnsmasq dnsmasq-full \
          e2fsprogs \
          autocore automount default-settings-chn dropbear fdisk firewall4 fstools \
          kmod-button-hotplug kmod-nft-offload libustream-openssl logd luci-app-package-manager luci-compat luci-lib-base luci-lib-ipkg luci-light \
          netifd nftables odhcp6c odhcpd-ipv6only opkg partx-utils ppp ppp-mod-pppoe procd-ujail uci kmod-nf-nathelper \
          uclient-fetch urandom-seed urngd kmod-amazon-ena kmod-dwmac-intel kmod-forcedeth kmod-usb-hid i915-firmware-dmc \
          luci-theme-argon kmod-nft-tproxy kmod-sched-core kmod-sched-cake kmod-crypto-cbc kmod-crypto-ctr kmod-ata-ahci kmod-drm-i915 \
          kmod-hwmon-core kmod-i2c-core rsync curl htop kmod-e1000e kmod-i40e kmod-igb \
          kmod-igbvf kmod-ixgbe -kmod-ixgbevf kmod-pcnet32 kmod-tulip kmod-vmxnet3" 
          
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: 7. 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt_x86_64_firmware
          path: ib_dir/bin/targets/x86/64/*

      - name: 8. 生成 Release 信息
        run: |
          echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "## ImmortalWrt x86-64 固件发布" >> $GITHUB_ENV
          echo "### 固件特性" >> $GITHUB_ENV
          echo "- **自动扩容**: 首次启动后自动扩展 (Fdisk版)" >> $GITHUB_ENV
          echo "- **DNS组件**: dnsmasq-full" >> $GITHUB_ENV
          echo "- **内核版本**: ${{ env.REPO_BRANCH }}" >> $GITHUB_ENV
          echo "- **构建时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "### 默认配置" >> $GITHUB_ENV
          echo "- IP 地址: 192.168.31.1" >> $GITHUB_ENV
          echo "- 密码: 无 (空)" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 9. 发布 Release
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.FIRMWARE_NAME }}-${{ env.MAIN_VERSION }}-${{ env.RELEASE_DATE }}"
          artifacts: "ib_dir/bin/targets/x86/64/*"
          body: ${{ env.RELEASE_BODY }}
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
